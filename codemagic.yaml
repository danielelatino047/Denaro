workflows:
  expo-android-apk:
    name: Expo Android APK Build
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      node: 20.11.0
      vars:
        EXPO_TOKEN: $EXPO_TOKEN # Set this in Codemagic environment variables
    cache:
      cache_paths:
        - node_modules
        - ~/.bun
        - ~/.expo
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true
        - pattern: master
          include: true
          source: true
    scripts:
      - name: Install Bun
        script: |
          curl -fsSL https://bun.sh/install | bash
          export PATH="$HOME/.bun/bin:$PATH"
          echo 'export PATH="$HOME/.bun/bin:$PATH"' >> ~/.bashrc
      - name: Install dependencies
        script: |
          export PATH="$HOME/.bun/bin:$PATH"
          bun install --frozen-lockfile
      - name: Install Expo CLI
        script: |
          export PATH="$HOME/.bun/bin:$PATH"
          bun add -g @expo/cli@latest eas-cli@latest
      - name: Expo Login
        script: |
          export PATH="$HOME/.bun/bin:$PATH"
          expo login --non-interactive
      - name: Build Android APK with EAS
        script: |
          export PATH="$HOME/.bun/bin:$PATH"
          eas build --platform android --profile preview --non-interactive --wait
    artifacts:
      - "*.apk"
    publishing:
      email:
        recipients:
          - daniele.latino047@gmail.com
        notify:
          success: true
          failure: true